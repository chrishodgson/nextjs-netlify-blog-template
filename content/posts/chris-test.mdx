---
slug: chris-test
title: Chris Test
date: 2021-11-11
author: wutali
---
Here is some cool code

```typescript
import { response } from '@app/common/functions/response.function';
import { getErrorStatus } from '@app/common/functions/get-error-status.function';
import { initializeSQS } from '@app/common/functions';
import { getMessagesFromQueue, getQueueUrlFromName, sendMessageToQueue, deleteMessageFromQueue } from '@app/common/functions/sqs-functions';
import { Message } from 'aws-sdk/clients/sqs';

function filterFulfilledResults(results: PromiseSettledResult<Message>[]): Message[] {
  return results.filter((result: PromiseSettledResult<Message>) => result.status = 'fulfilled').map((result: PromiseFulfilledResult<Message>) => result.value)
}

function filterRejectedResults(results: PromiseSettledResult<Message>[]): string[] {
  return results.filter((result: PromiseSettledResult<Message>) => result.status = 'rejected').map((result: PromiseRejectedResult) => result.reason.toString())
}

export const lambdaHandler = async (): Promise<any> => {
  try {
    const sqs = initializeSQS()
    const sourceQueueName = process.env.SOURCE_QUEUE_NAME || ''
    const destinationQueueName = process.env.DESTINATION_QUEUE_NAME || ''
    const sourceQueueUrl = await getQueueUrlFromName(sourceQueueName, sqs)
    const destinationQueueUrl = await getQueueUrlFromName(destinationQueueName, sqs)
    const maxGetMessageAttempts = 20;
    const getMessageBatchSize = 10;

    let messageSentCount = 0;
    let messageReceiveCount = 0;
    let messageDeleteCount = 0;
    let getMessageAttempts = 0;

    while (getMessageAttempts <= maxGetMessageAttempts) {
      getMessageAttempts += 1

      // get batch of messages from source queue
      const messages = await getMessagesFromQueue(sourceQueueUrl, getMessageBatchSize, sqs)
      if (messages.length === 0) {
        console.log(`Attempt ${getMessageAttempts}, ${messages.length} messages retrieved`)
        break;
      }
      messageReceiveCount += messages.length

      // send batch of messages to destination queue
      const sendMessageResults: PromiseSettledResult<Message>[] = await Promise.allSettled(
        messages.map((message: Message) => sendMessageToQueue(destinationQueueUrl, message, sqs))
      )
      console.log( filterRejectedResults(sendMessageResults), 'Failed to send' )

      const sentMessages: Message[] = filterFulfilledResults(sendMessageResults)
      messageSentCount += sentMessages.length

      // delete any sent messages from the source queue
      const deleteMessageResults: PromiseSettledResult<Message>[] = await Promise.allSettled(
        sentMessages.map((message: Message) => deleteMessageFromQueue(destinationQueueUrl, message, sqs))
      )
      console.log( filterRejectedResults(deleteMessageResults), 'Failed to delete' )

      messageDeleteCount += sentMessages.length
    }

    const message = `Sent ${messageSentCount} messages to ${sourceQueueName}. Deleted ${messageDeleteCount} messages from ${destinationQueueName}.
      Total messages retrieved: ${messageReceiveCount} in ${getMessageAttempts} get Message attempts.`

    return response({ message }, 200);
  } catch (error) {
    return response({ message: error.toString() }, getErrorStatus(error), { error });
  }
};
```

something else to say here